# Messenger

Высокопроизводительный корпоративный мессенджер на Go с WebSocket‑чатом, доставкой сообщений, медиа и звонками (WebRTC). Проект разворачивается через Docker Compose и разделён на сервисы.

**Функционал**
- Авторизация по OTP на email
- Управление сессиями: список активных сессий, выход из текущей, выход со всех устройств
- Профили пользователей: имя, email, телефон, аватар
- Поиск пользователей
- Админ‑функции: создание пользователей, управление правами, отключение пользователей, список сотрудников
- Личные чаты
- Групповые чаты: создание, изменение названия/описания/аватара, добавление/удаление участников, выход из группы
- Системные сообщения о событиях в группе
- «Избранные» чаты
- «Заметки» (личный чат с самим собой)
- Сообщения в реальном времени по WebSocket
- Индикатор «печатает»
- Статусы онлайн/оффлайн
- Непрочитанные и отметка «прочитано»
- Редактирование и удаление сообщений
- Ответы (reply) на сообщения
- Реакции (эмодзи) и закреплённые сообщения
- Поиск по сообщениям
- Файлы и вложения
- Голосовые сообщения (audio‑сервис)
- Push‑уведомления (Web Push + VAPID)
- Звонки WebRTC: сигналинг, offer/answer/ICE, принять/отклонить/завершить

**Сервисы**
- `frontend` — веб‑клиент (Nginx + статические файлы)
- `nginx` — публичный reverse‑proxy
- `api` — основной HTTP/WebSocket API
- `auth` — аутентификация и сессии
- `files` — загрузка/выдача файлов
- `push` — push‑уведомления
- `audio` — голосовые сообщения
- `call` — сигналинг звонков (WebRTC)
- `postgres` — база данных
- `redis` — кэш/сессии

**Запуск через Docker Compose**

1. Скопируйте пример окружения и заполните значения:

```bash
cp services/infra/.env.example .env
```

2. Минимально проверьте переменные:

```bash
# SMTP_* для отправки OTP
# CORS_ALLOWED_ORIGINS в production
# VAPID_* для push (можно сгенерировать: go run ./services/push/ --gen-vapid)
# CALL_ICE_SERVERS для WebRTC (STUN/TURN)
```

3. Запустите стек:

```bash
docker compose up -d --build
# или
make up
```

4. Доступ к приложению:

```text
http://localhost
```

Остановка:

```bash
docker compose down
# или
make down
```

Логи:

```bash
docker compose logs -f
```

Полный сброс данных (DEV):

```bash
make reset
```

**Звонки (WebRTC)**

ICE‑серверы задаются через `CALL_ICE_SERVERS` в JSON формате. Пример:

```bash
CALL_ICE_SERVERS='[
  {"urls": ["stun:stun.l.google.com:19302"]},
  {"urls": ["turn:turn.example.com:3478"], "username": "user", "credential": "pass"}
]'
```

Клиент получает конфигурацию через `/api/config/call`.

**Документация**
- `docs/README.md`
- `docs/DEPLOY.md`
- `docs/GO_AGENT_RULES.md`

**Деплой**
Скрипты деплоя находятся в `tools/deploy/`. Рекомендации — в `docs/DEPLOY.md`.
