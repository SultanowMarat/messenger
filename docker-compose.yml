# Messenger: весь стек через Docker Compose (БД, Redis, Auth, API + SPA).
# Доступ: HTTP 80. Данные: ./data/
# Логи сервисов также пишутся в файлы: services/<сервис>/logs/app.log (и nginx — в services/nginx/logs/)
#
# Запуск:  docker compose up -d --build   (или make up)
# Остановка:  docker compose down
# Логи в консоль:  docker compose logs -f

services:
  postgres:
    image: postgres:16-alpine
    container_name: messenger-db
    command: ["postgres", "-c", "max_connections=250"]
    env_file:
      - ./services/infra/postgres.env
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U messenger"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: messenger-redis
    command: redis-server /etc/redis/redis.conf
    volumes:
      - ./services/infra/redis.conf:/etc/redis/redis.conf
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  auth:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
      platforms: [linux/amd64]
    container_name: messenger-auth
    env_file:
      - ./.env
    environment:
      CONFIG_PATH: "config/auth.yaml"
      SERVER_ADDR: ":8081"
      DATABASE_URL: "postgres://messenger:messenger_secret@postgres:5432/messenger?sslmode=disable"
      REDIS_URL: "redis://redis:6379"
      SMTP_HOST: "${SMTP_HOST:-smtp.yandex.ru}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_USERNAME: "${SMTP_USERNAME:-}"
      SMTP_PASSWORD: "${SMTP_PASSWORD:-}"
      SMTP_FROM_EMAIL: "${SMTP_FROM_EMAIL:-}"
      SMTP_FROM_NAME: "${SMTP_FROM_NAME:-Auth Service}"
      CORS_ALLOWED_ORIGINS: "${CORS_ALLOWED_ORIGINS:-*}"
      DEBUG: "${DEBUG:-}"
    volumes:
      - ./services/auth/config:/app/config:ro
      - ./services/auth/logs:/var/log/messenger
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8081/health"]
      interval: 5s
      timeout: 3s
      retries: 5
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  push:
    build:
      context: .
      dockerfile: services/push/Dockerfile
      platforms: [linux/amd64]
    container_name: messenger-push
    environment:
      SERVER_ADDR: ":8082"
      REDIS_URL: "redis://redis:6379"
      VAPID_PUBLIC_KEY: "${VAPID_PUBLIC_KEY:-}"
      VAPID_PRIVATE_KEY: "${VAPID_PRIVATE_KEY:-}"
      VAPID_KEYS_FILE: "/app/config/vapid.json"
    volumes:
      - ./data/push:/app/config
      - ./services/push/logs:/var/log/messenger
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8082/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  files:
    build:
      context: .
      dockerfile: services/files/Dockerfile
      platforms: [linux/amd64]
    container_name: messenger-files
    environment:
      SERVER_ADDR: ":8083"
      UPLOAD_DIR: "/app/uploads"
      MAX_UPLOAD_SIZE_MB: "20"
    volumes:
      - ./data/uploads:/app/uploads
      - ./services/files/logs:/var/log/messenger
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8083/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  audio:
    build:
      context: .
      dockerfile: services/audio/Dockerfile
      platforms: [linux/amd64]
    container_name: messenger-audio
    environment:
      SERVER_ADDR: ":8084"
      UPLOAD_DIR: "/app/uploads"
      MAX_UPLOAD_SIZE_MB: "25"
      CHOWN_DIRS: "/app/uploads"
    volumes:
      - ./data/audio:/app/uploads
      - ./services/audio/logs:/var/log/messenger
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8084/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  call:
    build:
      context: .
      dockerfile: services/call/Dockerfile
      platforms: [linux/amd64]
    container_name: messenger-call
    environment:
      SERVER_ADDR: ":8085"
      API_URL: "http://api:8080"
    volumes:
      - ./services/call/logs:/var/log/messenger
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8085/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: services/frontend/Dockerfile
      platforms: [linux/amd64]
    container_name: messenger-frontend
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
      platforms: [linux/amd64]
    container_name: messenger-api
    environment:
      CONFIG_PATH: "config/api.yaml"
      SERVER_ADDR: ":8080"
      DATABASE_URL: "postgres://messenger:messenger_secret@postgres:5432/messenger?sslmode=disable"
      AUTH_SERVICE_URL: "http://auth:8081"
      PUSH_SERVICE_URL: "http://push:8082"
      PUSH_VAPID_PUBLIC_KEY: "${VAPID_PUBLIC_KEY:-}"
      VAPID_KEYS_FILE: "/app/vapid/vapid.json"
      FILE_SERVICE_URL: "http://files:8083"
      AUDIO_SERVICE_URL: "http://audio:8084"
      CORS_ALLOWED_ORIGINS: "${CORS_ALLOWED_ORIGINS:-*}"
    volumes:
      - ./services/api/config:/app/config:ro
      - ./data/push:/app/vapid
      - ./services/api/logs:/var/log/messenger
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 90s
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  nginx:
    build:
      context: .
      dockerfile: services/nginx/Dockerfile
      platforms: [linux/amd64]
    container_name: messenger-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./services/nginx/config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./services/nginx/logs:/var/log/nginx
    depends_on:
      - frontend
      - api
      - call
