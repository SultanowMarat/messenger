<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Мессенджер — адрес сервера</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
    }
    .card {
      width: 100%;
      max-width: 420px;
      padding: 32px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,.08);
    }
    h1 { font-size: 22px; font-weight: 600; margin: 0 0 8px; }
    .sub { font-size: 14px; color: #6e6e73; margin-bottom: 24px; }
    label { display: block; font-size: 13px; font-weight: 500; color: #424245; margin-bottom: 6px; }
    input {
      width: 100%;
      padding: 12px 14px;
      font-size: 15px;
      border: 1px solid #d2d2d7;
      border-radius: 10px;
      margin-bottom: 8px;
    }
    input:focus { outline: none; border-color: #0071e3; }
    .error { font-size: 13px; color: #d70015; margin-bottom: 12px; font-weight: 500; }
    .buttons { display: flex; gap: 10px; margin-top: 20px; }
    button {
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .primary {
      background: #0071e3;
      color: #fff;
      flex: 1;
    }
    .primary:hover { background: #0077ed; }
    .primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .secondary {
      background: #e8e8ed;
      color: #1d1d1f;
    }
    .secondary:hover { background: #d2d2d7; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Мессенджер</h1>
    <p class="sub">Введите адрес сервера приложения</p>
    <form id="form">
      <label for="url">Адрес сервера</label>
      <input type="url" id="url" placeholder="https://example.com" autocomplete="url" />
      <div id="error" class="error" hidden></div>
      <div class="buttons">
        <button type="button" id="check" class="secondary">Проверить</button>
        <button type="submit" id="open" class="primary">Открыть</button>
      </div>
    </form>
  </div>
  <script>
    const urlInput = document.getElementById('url');
    const errorEl = document.getElementById('error');
    const openBtn = document.getElementById('open');
    const checkBtn = document.getElementById('check');

    function showError(msg) {
      errorEl.textContent = msg || '';
      errorEl.hidden = !msg;
    }

    function normalizeUrl(val) {
      const u = (val || '').trim();
      if (!u) return '';
      return /^https?:\/\//i.test(u) ? u : 'https://' + u;
    }

    async function checkReachable(url) {
      const base = normalizeUrl(url);
      if (!base) return false;
      try {
        const c = new AbortController();
        const t = setTimeout(() => c.abort(), 8000);
        const r = await fetch(base + '/health', { method: 'GET', signal: c.signal });
        clearTimeout(t);
        return r.ok;
      } catch {
        try {
          const c = new AbortController();
          const t = setTimeout(() => c.abort(), 5000);
          const r = await fetch(base, { method: 'GET', signal: c.signal });
          clearTimeout(t);
          return r.ok;
        } catch {
          return false;
        }
      }
    }

    async function doOpen() {
      const raw = urlInput.value.trim() || urlInput.placeholder;
      const url = normalizeUrl(raw);
      if (!url) {
        showError('Введите адрес сервера');
        return;
      }
      showError('');
      openBtn.disabled = true;
      const ok = await checkReachable(url);
      openBtn.disabled = false;
      if (!ok) {
        showError('Адрес недоступен');
        return;
      }
      if (window.electronAPI && typeof window.electronAPI.openAppUrl === 'function') {
        window.electronAPI.openAppUrl(url);
      }
    }

    checkBtn.addEventListener('click', async () => {
      const url = normalizeUrl(urlInput.value);
      if (!url) {
        showError('Введите адрес сервера');
        return;
      }
      showError('');
      checkBtn.disabled = true;
      const ok = await checkReachable(url);
      checkBtn.disabled = false;
      showError(ok ? '' : 'Адрес недоступен');
    });

    document.getElementById('form').addEventListener('submit', (e) => {
      e.preventDefault();
      doOpen();
    });

    (async () => {
      if (window.electronAPI && typeof window.electronAPI.getServerUrl === 'function') {
        const stored = await window.electronAPI.getServerUrl();
        if (stored) urlInput.value = stored;
      }
    })();
  </script>
</body>
</html>
