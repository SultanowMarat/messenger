package repository

import (
	"context"
	"errors"
	"fmt"
	"time"

	"github.com/jackc/pgx/v5"
	"github.com/jackc/pgx/v5/pgxpool"
	"github.com/messenger/internal/logger"
	"github.com/messenger/internal/model"
)

type PermissionRepository struct {
	pool *pgxpool.Pool
}

func NewPermissionRepository(pool *pgxpool.Pool) *PermissionRepository {
	return &PermissionRepository{pool: pool}
}

// GetByUserID возвращает права пользователя. Если записи нет — возвращает нулевые права без ошибки.
func (r *PermissionRepository) GetByUserID(ctx context.Context, userID string) (*model.UserPermissions, error) {
	defer logger.DeferLogDuration("permission.GetByUserID", time.Now())()
	p := &model.UserPermissions{UserID: userID}
	err := r.pool.QueryRow(ctx,
		`SELECT user_id, COALESCE(administrator, false), COALESCE(member, true), admin_all_groups, delete_others_messages, manage_bots,
		        edit_others_profile, invite_to_team, remove_from_team, updated_at
		 FROM user_permissions WHERE user_id = $1`,
		userID,
	).Scan(
		&p.UserID,
		&p.Administrator,
		&p.Member,
		&p.AdminAllGroups,
		&p.DeleteOthersMessages,
		&p.ManageBots,
		&p.EditOthersProfile,
		&p.InviteToTeam,
		&p.RemoveFromTeam,
		&p.UpdatedAt,
	)
	if errors.Is(err, pgx.ErrNoRows) {
		return p, nil
	}
	if err != nil {
		return nil, fmt.Errorf("permissionRepo.GetByUserID: %w", err)
	}
	return p, nil
}

// Upsert создаёт или обновляет права пользователя.
func (r *PermissionRepository) Upsert(ctx context.Context, p *model.UserPermissions) error {
	defer logger.DeferLogDuration("permission.Upsert", time.Now())()
	now := time.Now()
	_, err := r.pool.Exec(ctx,
		`INSERT INTO user_permissions (
			user_id, administrator, member, admin_all_groups, delete_others_messages, manage_bots,
			edit_others_profile, invite_to_team, remove_from_team, updated_at
		) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
		ON CONFLICT (user_id) DO UPDATE SET
			administrator = EXCLUDED.administrator,
			member = EXCLUDED.member,
			admin_all_groups = EXCLUDED.admin_all_groups,
			delete_others_messages = EXCLUDED.delete_others_messages,
			manage_bots = EXCLUDED.manage_bots,
			edit_others_profile = EXCLUDED.edit_others_profile,
			invite_to_team = EXCLUDED.invite_to_team,
			remove_from_team = EXCLUDED.remove_from_team,
			updated_at = EXCLUDED.updated_at`,
		p.UserID,
		p.Administrator,
		p.Member,
		p.AdminAllGroups,
		p.DeleteOthersMessages,
		p.ManageBots,
		p.EditOthersProfile,
		p.InviteToTeam,
		p.RemoveFromTeam,
		now,
	)
	if err != nil {
		return fmt.Errorf("permissionRepo.Upsert: %w", err)
	}
	p.UpdatedAt = now
	return nil
}
